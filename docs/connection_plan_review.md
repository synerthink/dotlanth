# Connection Plan â€“ Review & Development Roadmap

This document reviews the existing **`tmp_rovodev_connection_plan.md`** and proposes a concrete, _actionâ€‘oriented_ roadmap that the team can follow.  It is organised as a set of incremental milestones, each with explicit deliverables, acceptance criteria, and risk mitigation notes.

> **Scope**  
> The focus is limited to *connectivity layers* (gRPC, REST, GraphQL, WebSockets) and any supporting infrastructure (authentication, observability, CI/CD).  Runtime or VMâ€‘level details are outâ€‘ofâ€‘scope unless they directly affect the transport layer.

---

## 1. Highâ€‘Level Observations

| ğŸ” | Observation | Impact |
|---|-------------|--------|
| 1 | The current plan is featureâ€‘rich but **lacks sequencing** & prioritisation. | Hard to estimate resources & timeline. |
| 2 | **No success metrics** are defined (e.g. latency targets, error budgets). | Risk of â€œdoneâ€ being subjective. |
| 3 | Security is mentioned only as *AuthÂ middleware*; **threat modelling** & key management are not covered. | Potential compliance gaps. |
| 4 | CI/CD integration, staging environments and rollback strategy are missing. | Slower feedback loop and higher prod risk. |
| 5 | The gRPC service explosion (â€†â‰¥â€†4 services) could be overkill for PhaseÂ 1. | Increased code churn & review overhead. |

---

## 2. Recommended Milestones

Below is a **fourâ€‘milestone roadmap** mapped roughly to sprints (â‡¢â€¯2â€¯weeks each) but can be adjusted.

### MilestoneÂ 0 â€“ Foundations  (â±Â 1Â sprint)

Deliverables
1. Upgrade the existing Runtime gRPC server to *service versionâ€¯`v1`*.
2. Introduce a minimal **AuthN/AuthZ interceptor** (tokenâ€‘based, no persistence yet).
3. Add **structured logging** and **otel tracing** hooks.

Acceptance Criteria
â€¢ `grpcurl` ping shows roundâ€‘trip withinâ€¯â‰¤â€¯30â€¯ms on localhost.  
â€¢ Logs contain `trace_id` + `span_id`.  
â€¢ Requests without a Bearer token are denied âŸ¶ `Unauthenticated`.

Risks & Mitigation
â€¢ *Overâ€‘engineering*: keep config in `config/default.toml`; no dynamic discovery yet.

---

### MilestoneÂ 1 â€“ gRPC Service Expansion  (â±Â 2Â sprints)

Scope reduction: **VMÂ Service + MonitoringÂ Service only**; Database & Cluster to be revisited later.

Deliverables
1. `vm_service.proto` + `monitoring_service.proto` with at most 3 RPCs each.  
2. CI job to autoâ€‘generate stubs âœ `crates/*/src/pb/â€¦`.
3. **Interâ€‘service metrics** exported via Prometheus exporter.

Acceptance Criteria
â€¢ Dot deploy & execute gRPC calls succeed in integration test.  
â€¢ `curl /metrics` exposes `grpc_server_handled_total`.

Risks
â€¢ **Proto churn** â€“ enforce breakingâ€‘change checks with Buf.

---

### MilestoneÂ 2 â€“ REST Gateway  (â±Â 2Â sprints)

Deliverables
1. New crate `dotlanth-api` using **Axum** running on portâ€¯`8080`.  
2. REST â†” gRPC translation layer using `tonic::transport::Channel`.  
3. `openapi.yaml` autoâ€‘generated by **utoipa** and published to GitHub Pages.

Acceptance Criteria
â€¢ `POST /api/v1/vm/dots/deploy` reaches gRPC backend (assert with span).  
â€¢ CORS preâ€‘flight for `localhost:3000` passes.  
â€¢ `make swagger-ui` opens interactive docs.

Risks
â€¢ Latency budget (REST adds â‰ˆ5â€‘10â€¯ms).  
â€¢ Spec drift â€“ add snapshot tests for OpenAPI.

---

### MilestoneÂ 3 â€“ Edge Features & Hardening  (â±Â 3Â sprints)

Deliverables
1. **GraphQL API** powered by `async-graphql` (readâ€‘only queries first).  
2. **WebSocket** streaming endpoint for realâ€‘time events.  
3. **Rate limiting** & **audit logging** middleware.  
4. Blue/Green deployment workflow in CI.

Acceptance Criteria
â€¢ GraphQL introspection works in GraphiQL.  
â€¢ WebSocket sends â‰¥Â 1Â eventâ€¯/â€¯s for block commits.  
â€¢ Canary release can be promoted/rolled back within 1â€¯click.

Risks
â€¢ Increased operational complexity â€“ document runâ€‘books.

---

## 3. Crossâ€‘Cutting Concerns

1. **Security**  
   â€¢ Perform STRIDE threat model before Phaseâ€¯2.  
   â€¢ Rotate tokens with `jwks` endpoint.

2. **Observability**  
   â€¢ Adopt OpenTelemetry across all crates.  
   â€¢ Use `traceâ€‘fmt` for JSON logs.

3. **Testing**  
   â€¢ gRPC dot tests with `cucumber_rust`.  
   â€¢ REST smoke tests via `schemathesis`.

4. **CI/CD**  
   â€¢ GitHub Actions matrix: `stable`, `beta`, `nightly`.  
   â€¢ Automated docker image scan with Trivy.

5. **Documentation**  
   â€¢ Keep protocol docs in `/docs/proto/` rendered with `buf generate docs`.

---

## 4. Recommended Next Steps

1. **Team Kickâ€‘off Workshop** â€“ align on milestones & assign owners.
2. Migrate the existing plan into **GitHub Projects** with milestone columns.
3. Draft RFCâ€‘001 _â€œConnectivity Layersâ€_ for approval.
4. Start MilestoneÂ 0 implementation.

---

## 5. Appendix â€“ Fastâ€‘Fail Checklist

| âœ”ï¸ | Question |
|----|----------|
|   | Do we have latency/error budgets for each API? |
|   | Are proto files versioned and backwardsâ€‘compatible? |
|   | Is there a rollback plan for the API gateway? |
|   | Are secrets (tokens, keys) rotated *at least* every 90â€¯days? |
|   | Is e2e encryption enforced on all external channels? |

Filling this checklist during each milestone review helps surface hidden work early.

