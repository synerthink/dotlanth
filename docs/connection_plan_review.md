# Connection Plan – Review & Development Roadmap

This document reviews the existing **`tmp_rovodev_connection_plan.md`** and proposes a concrete, _action‑oriented_ roadmap that the team can follow.  It is organised as a set of incremental milestones, each with explicit deliverables, acceptance criteria, and risk mitigation notes.

> **Scope**  
> The focus is limited to *connectivity layers* (gRPC, REST, GraphQL, WebSockets) and any supporting infrastructure (authentication, observability, CI/CD).  Runtime or VM‑level details are out‑of‑scope unless they directly affect the transport layer.

---

## 1. High‑Level Observations

| 🔍 | Observation | Impact |
|---|-------------|--------|
| 1 | The current plan is feature‑rich but **lacks sequencing** & prioritisation. | Hard to estimate resources & timeline. |
| 2 | **No success metrics** are defined (e.g. latency targets, error budgets). | Risk of “done” being subjective. |
| 3 | Security is mentioned only as *Auth middleware*; **threat modelling** & key management are not covered. | Potential compliance gaps. |
| 4 | CI/CD integration, staging environments and rollback strategy are missing. | Slower feedback loop and higher prod risk. |
| 5 | The gRPC service explosion ( ≥ 4 services) could be overkill for Phase 1. | Increased code churn & review overhead. |

---

## 2. Recommended Milestones

Below is a **four‑milestone roadmap** mapped roughly to sprints (⇢ 2 weeks each) but can be adjusted.

### Milestone 0 – Foundations  (⏱ 1 sprint)

Deliverables
1. Upgrade the existing Runtime gRPC server to *service version `v1`*.
2. Introduce a minimal **AuthN/AuthZ interceptor** (token‑based, no persistence yet).
3. Add **structured logging** and **otel tracing** hooks.

Acceptance Criteria
• `grpcurl` ping shows round‑trip within ≤ 30 ms on localhost.  
• Logs contain `trace_id` + `span_id`.  
• Requests without a Bearer token are denied ⟶ `Unauthenticated`.

Risks & Mitigation
• *Over‑engineering*: keep config in `config/default.toml`; no dynamic discovery yet.

---

### Milestone 1 – gRPC Service Expansion  (⏱ 2 sprints)

Scope reduction: **VM Service + Monitoring Service only**; Database & Cluster to be revisited later.

Deliverables
1. `vm_service.proto` + `monitoring_service.proto` with at most 3 RPCs each.  
2. CI job to auto‑generate stubs ➜ `crates/*/src/pb/…`.
3. **Inter‑service metrics** exported via Prometheus exporter.

Acceptance Criteria
• Dot deploy & execute gRPC calls succeed in integration test.  
• `curl /metrics` exposes `grpc_server_handled_total`.

Risks
• **Proto churn** – enforce breaking‑change checks with Buf.

---

### Milestone 2 – REST Gateway  (⏱ 2 sprints)

Deliverables
1. New crate `dotlanth-api` using **Axum** running on port `8080`.  
2. REST ↔ gRPC translation layer using `tonic::transport::Channel`.  
3. `openapi.yaml` auto‑generated by **utoipa** and published to GitHub Pages.

Acceptance Criteria
• `POST /api/v1/vm/dots/deploy` reaches gRPC backend (assert with span).  
• CORS pre‑flight for `localhost:3000` passes.  
• `make swagger-ui` opens interactive docs.

Risks
• Latency budget (REST adds ≈5‑10 ms).  
• Spec drift – add snapshot tests for OpenAPI.

---

### Milestone 3 – Edge Features & Hardening  (⏱ 3 sprints)

Deliverables
1. **GraphQL API** powered by `async-graphql` (read‑only queries first).  
2. **WebSocket** streaming endpoint for real‑time events.  
3. **Rate limiting** & **audit logging** middleware.  
4. Blue/Green deployment workflow in CI.

Acceptance Criteria
• GraphQL introspection works in GraphiQL.  
• WebSocket sends ≥ 1 event / s for block commits.  
• Canary release can be promoted/rolled back within 1 click.

Risks
• Increased operational complexity – document run‑books.

---

## 3. Cross‑Cutting Concerns

1. **Security**  
   • Perform STRIDE threat model before Phase 2.  
   • Rotate tokens with `jwks` endpoint.

2. **Observability**  
   • Adopt OpenTelemetry across all crates.  
   • Use `trace‑fmt` for JSON logs.

3. **Testing**  
   • gRPC dot tests with `cucumber_rust`.  
   • REST smoke tests via `schemathesis`.

4. **CI/CD**  
   • GitHub Actions matrix: `stable`, `beta`, `nightly`.  
   • Automated docker image scan with Trivy.

5. **Documentation**  
   • Keep protocol docs in `/docs/proto/` rendered with `buf generate docs`.

---

## 4. Recommended Next Steps

1. **Team Kick‑off Workshop** – align on milestones & assign owners.
2. Migrate the existing plan into **GitHub Projects** with milestone columns.
3. Draft RFC‑001 _“Connectivity Layers”_ for approval.
4. Start Milestone 0 implementation.

---

## 5. Appendix – Fast‑Fail Checklist

| ✔️ | Question |
|----|----------|
|   | Do we have latency/error budgets for each API? |
|   | Are proto files versioned and backwards‑compatible? |
|   | Is there a rollback plan for the API gateway? |
|   | Are secrets (tokens, keys) rotated *at least* every 90 days? |
|   | Is e2e encryption enforced on all external channels? |

Filling this checklist during each milestone review helps surface hidden work early.

